configfile: "config.yml"

rule all:
    input:
        "join/all.txt"

rule bam_tofastq:
    input:
        "bam_tofastq/{sample}/{sample}.txt"
    output:
        "fastq/{sample}/pass.txt",
    params:
        script = "script/{sample}/singularity_bam_tofastq.sh",
        yaml = "script/{sample}/conf_bam_tofastq.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule bwa:
    input:
        lambda wildcards: config["aln_samples"][wildcards.sample],
    output:
        "bam/{sample}/{sample}.markdup.bam"
    params:
        script = "script/{sample}/singularity_bwa_alignment.sh",
        yaml = "script/{sample}/conf_bwa_alignment.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule mutation:
    input:
        lambda wildcards: config["mutation_samples"][wildcards.sample],
    output:
        "mutation/{sample}/{sample}.txt"
    params:
        script = "script/{sample}/singularity_mutation_dummy.sh",
        yaml = "script/{sample}/conf_mutation_dummy.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule sv:
    input:
        lambda wildcards: config["sv_samples"][wildcards.sample]
    output:
        "sv/{sample}/{sample}.txt"
    params:
        script = "script/{sample}/singularity_sv_dummy.sh",
        yaml = "script/{sample}/conf_sv_dummy.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule qc_bamstats:
    input:
        lambda wildcards: config["qc_samples"][wildcards.sample]
    output:
        "qc/{sample}/{sample}.bamstats"
    params:
        script = "script/{sample}/singularity_qc_bamstats.sh",
        yaml = "script/{sample}/conf_qc_bamstats.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule qc_coverage:
    input:
        lambda wildcards: config["qc_samples"][wildcards.sample]
    output:
        "qc/{sample}/{sample}.coverage"
    params:
        script = "script/{sample}/singularity_qc_coverage.sh",
        yaml = "script/{sample}/conf_qc_coverage.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule qc_merge:
    input:
        lambda wildcards: config["qc_merge_samples"][wildcards.sample],
    output:
        "qc/{sample}/{sample}.genomonQC.result.txt"
    params:
        script = "script/{sample}/singularity_qc_merge.sh",
        yaml = "script/{sample}/conf_qc_merge.yml"
    shell:
        "genomon_runner {params.script} {params.yaml}"

rule join:
    input:
        ["{dataset}".format(dataset=dataset) for dataset in config["output_files"]]
    output:
        "join/all.txt"
    shell:
        "cat {input} > {output}"

